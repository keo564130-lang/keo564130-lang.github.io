<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–ü–ì: –ì—Ä—è–∑–Ω—ã–µ –°—Ö–µ–º—ã</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --primary: #00e676; /* Dirty Green */
            --danger: #ff1744; /* Blood Red */
            --clean: #2979ff; /* Clean Blue */
            --text: #ffffff;
            --gold: #ffc107;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 500px;
            padding: 15px;
            box-sizing: border-box;
        }
        h1, h2, h3 { text-align: center; margin: 10px 0; }
        .logo { font-size: 2em; text-align: center; margin-bottom: 20px; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-clean { background: var(--clean); color: #fff; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* Inputs */
        input {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #2a2a2a;
            color: white;
            box-sizing: border-box;
        }

        /* –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .money-dirty { color: var(--primary); }
        .money-clean { color: var(--clean); font-weight: bold; }
        .risk-high { color: var(--danger); }
        
        .progress-bar {
            background: #333;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }
        .progress-fill {
            height: 100%;
            background: var(--clean);
            width: 0%;
            transition: width 0.5s;
        }

        .log-box {
            height: 150px;
            overflow-y: auto;
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            font-size: 0.9em;
            font-family: monospace;
            border-radius: 8px;
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-bad { color: var(--danger); }
        .log-good { color: var(--primary); }

        /* –°–∫—Ä—ã—Ç—ã–µ —ç–∫—Ä–∞–Ω—ã */
        .screen { display: none; }
        .active { display: block; }
        
        .target-select { display: flex; gap: 5px; }
        .target-btn { flex: 1; background: #333; color: white; }
        .target-btn.selected { background: var(--danger); }

        .game-id-display {
            background: #222;
            padding: 10px;
            text-align: center;
            border: 1px dashed var(--primary);
            margin-bottom: 15px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    
    <div id="screen-login" class="screen active">
        <div class="logo">üí∞ –û–ü–ì <br><small style="font-size:0.5em; color: #888">–ì—Ä—è–∑–Ω—ã–µ –°—Ö–µ–º—ã</small></div>
        <div class="card">
            <label>–¢–≤–æ—ë –ø–æ–≥–æ–Ω—è–ª–æ (–ò–º—è):</label>
            <input type="text" id="username" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢–æ–Ω–∏ –ú–æ–Ω—Ç–∞–Ω–∞">
            
            <button class="btn-primary" onclick="createGame()">–°–û–ó–î–ê–¢–¨ –ò–ì–†–£ (–Ø - –•–æ—Å—Ç)</button>
            
            <hr style="border-color: #333; margin: 20px 0;">
            
            <label>ID –ò–≥—Ä—ã (–≤–∑—è—Ç—å —É –•–æ—Å—Ç–∞):</label>
            <input type="text" id="join-id" placeholder="–í—Å—Ç–∞–≤—å ID —Å—é–¥–∞">
            <button class="btn-outline" onclick="joinGame()">–ü–†–ò–°–û–ï–î–ò–ù–ò–¢–¨–°–Ø</button>
        </div>
        <div id="status-msg" style="text-align: center; color: #888;"></div>
    </div>

    <div id="screen-lobby" class="screen">
        <div class="logo">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –±—Ä–∞—Ç–≤—ã</div>
        <div class="game-id-display" onclick="copyId()">
            ID –ò–≥—Ä—ã: <span id="display-game-id" style="font-weight:bold; color:var(--primary)">...</span>
            <br><small>(–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–∏–Ω—å –¥—Ä—É–∑—å—è–º)</small>
        </div>
        <div class="card">
            <h3>–°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤:</h3>
            <ul id="lobby-list" style="padding-left: 20px;"></ul>
        </div>
        <button id="start-btn" class="btn-primary" style="display:none;" onclick="startGame()">–ù–ê–ß–ê–¢–¨ –î–ï–õ–ê</button>
        <div id="waiting-host-msg" style="text-align:center; display:none;">–ñ–¥–µ–º, –ø–æ–∫–∞ –•–æ—Å—Ç –Ω–∞—á–Ω–µ—Ç –∏–≥—Ä—É...</div>
    </div>

    <div id="screen-game" class="screen">
        <div class="card" style="border: 1px solid var(--primary);">
            <div class="stat-row">
                <span>üë§ <span id="game-me-name">–Ø</span></span>
                <span id="game-turn-indicator" style="display:none">üîî –¢–í–û–ô –•–û–î</span>
            </div>
            <div class="stat-row">
                <span>üíµ –ö–∞—Ä–º–∞–Ω: <span id="game-me-dirty" class="money-dirty">0 $</span></span>
                <span>üî• –†–∏—Å–∫: <span id="game-me-risk" class="risk-high">0%</span></span>
            </div>
            <div class="stat-row" style="margin-top: 5px; border-top: 1px solid #333; padding-top:5px;">
                <span>üßº –û–±—â–∞–∫ (–¶–µ–ª—å: 5000): <span id="game-me-clean" class="money-clean">1000 $</span></span>
            </div>
            <div class="progress-bar"><div id="game-me-progress" class="progress-fill"></div></div>
            <div id="immunity-badge" style="display:none; color: var(--gold); text-align: center; font-size: 0.8em; margin-top: 5px;">üõ°Ô∏è –ê–î–í–û–ö–ê–¢ –ê–ö–¢–ò–í–ï–ù</div>
        </div>

        <div id="action-panel" class="card" style="display:none;">
            <h3>–¢–≤–æ–π —Ö–æ–¥:</h3>
            <button class="btn-primary" onclick="doAction('scheme')">üí∞ –ú—É—Ç–Ω–∞—è –°—Ö–µ–º–∞ (+$$$, +–†–∏—Å–∫)</button>
            <div style="display:flex; gap:5px;">
                <button class="btn-danger" style="flex:1" onclick="showStealMenu()">üö® –ü–æ–¥—Å—Ç–∞–≤–∞</button>
                <button class="btn-clean" style="flex:1" onclick="doAction('clean')">üßº –û—Ç–º—ã—Ç—å</button>
            </div>
            <button class="btn-gold" onclick="doAction('lawyer')">üõ°Ô∏è –ê–¥–≤–æ–∫–∞—Ç (-500$ –∏–∑ –û–±—â–∞–∫–∞)</button>

            <div id="steal-menu" style="display:none; margin-top:10px; background:#000; padding:10px; border-radius:8px;">
                <p>–ö–æ–≥–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å?</p>
                <div id="steal-targets" class="target-select"></div>
                <button class="btn-outline" style="margin-top:5px;" onclick="hideStealMenu()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
        <div id="waiting-turn-msg" style="text-align:center; color:#666; margin-bottom: 10px;">–ñ–¥–µ–º —Ö–æ–¥–∞ –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞...</div>

        <div class="card">
            <h3>üì° –ü—Ä–æ—Å–ª—É—à–∫–∞</h3>
            <div id="game-log" class="log-box"></div>
        </div>

        <div class="card">
            <h3>–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã</h3>
            <div id="opponents-list"></div>
        </div>
    </div>
</div>

<script>
    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
    let peer = null;
    let myId = null;
    let conn = []; // –î–ª—è —Ö–æ—Å—Ç–∞: –º–∞—Å—Å–∏–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    let hostConn = null; // –î–ª—è –∫–ª–∏–µ–Ω—Ç–∞: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ö–æ—Å—Ç–æ–º
    let isHost = false;
    let myName = "";
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã (—Ö—Ä–∞–Ω–∏—Ç—Å—è —É –•–æ—Å—Ç–∞, —Ä–∞—Å—Å—ã–ª–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–∞–º)
    let gameState = {
        players: [], // {id, name, dirty, clean, risk, immunity, isDead}
        turnIndex: 0,
        log: [],
        gameActive: false,
        winner: null
    };

    // --- –ù–ê–°–¢–†–û–ô–ö–ê PEERJS ---
    function initPeer() {
        // –°–æ–∑–¥–∞–µ–º Peer. –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä PeerJS (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
        peer = new Peer(null, {
            debug: 2
        });

        peer.on('open', (id) => {
            myId = id;
            console.log('My peer ID is: ' + id);
        });

        peer.on('connection', (c) => {
            // –õ–û–ì–ò–ö–ê –•–û–°–¢–ê: –ö—Ç–æ-—Ç–æ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
            if (isHost) {
                handleIncomingConnection(c);
            } else {
                // –ï—Å–ª–∏ —è –Ω–µ —Ö–æ—Å—Ç, —è –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–≤ —ç—Ç–æ–π –ø—Ä–æ—Å—Ç–æ–π –≤–µ—Ä—Å–∏–∏)
                c.close();
            }
        });
        
        peer.on('error', (err) => {
            alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + err.type);
            console.error(err);
        });
    }

    // --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function logToScreen(msg, type = 'neutral') {
        const logBox = document.getElementById('game-log');
        const div = document.createElement('div');
        div.className = 'log-entry ' + (type === 'bad' ? 'log-bad' : (type === 'good' ? 'log-good' : ''));
        div.innerText = `> ${msg}`;
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
    }

    // --- –õ–û–ì–ò–ö–ê –°–û–ó–î–ê–ù–ò–Ø / –í–•–û–î–ê ---
    
    function createGame() {
        myName = document.getElementById('username').value || "–ë–æ—Å—Å";
        isHost = true;
        initPeer();
        
        peer.on('open', (id) => {
            showScreen('screen-lobby');
            document.getElementById('display-game-id').innerText = id;
            document.getElementById('start-btn').style.display = 'block';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
            gameState.players.push(createPlayer(id, myName));
            updateLobbyUI();
        });
    }

    function joinGame() {
        myName = document.getElementById('username').value || "–ë–∞–Ω–¥–∏—Ç";
        const hostId = document.getElementById('join-id').value.trim();
        if(!hostId) return alert("–í–≤–µ–¥–∏ ID –∏–≥—Ä—ã!");

        isHost = false;
        initPeer();

        peer.on('open', (id) => {
            document.getElementById('status-msg').innerText = "–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É...";
            hostConn = peer.connect(hostId);

            hostConn.on('open', () => {
                console.log("Connected to host");
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Ö–æ–¥
                hostConn.send({ type: 'JOIN', name: myName });
                showScreen('screen-lobby');
                document.getElementById('waiting-host-msg').style.display = 'block';
            });

            hostConn.on('data', (data) => {
                handleClientData(data);
            });
        });
    }

    function copyId() {
        const id = document.getElementById('display-game-id').innerText;
        navigator.clipboard.writeText(id).then(() => alert("ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"));
    }

    // --- –õ–û–ì–ò–ö–ê –•–û–°–¢–ê ---

    function createPlayer(id, name) {
        return {
            id: id,
            name: name,
            dirty: 0,
            clean: 1000,
            risk: 0,
            immunity: false
        };
    }

    function handleIncomingConnection(c) {
        conn.push(c);
        
        c.on('data', (data) => {
            if (data.type === 'JOIN') {
                if (gameState.gameActive) {
                    // –ò–≥—Ä–∞ —É–∂–µ –∏–¥–µ—Ç, –Ω–µ–ª—å–∑—è
                    return; 
                }
                const newPlayer = createPlayer(c.peer, data.name);
                gameState.players.push(newPlayer);
                broadcastState();
            }
            if (data.type === 'ACTION') {
                processAction(data.action, data.payload, c.peer);
            }
        });

        c.on('close', () => {
            // –£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞ –µ—Å–ª–∏ –≤—ã—à–µ–ª (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
            gameState.players = gameState.players.filter(p => p.id !== c.peer);
            broadcastState();
        });
    }

    function broadcastState() {
        // –û–±–Ω–æ–≤–ª—è–µ–º UI —Ö–æ—Å—Ç–∞
        updateGameUI();
        updateLobbyUI();
        
        // –†–∞—Å—Å—ã–ª–∞–µ–º –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
        conn.forEach(c => {
            if(c.open) c.send({ type: 'UPDATE', state: gameState });
        });
    }

    function startGame() {
        if (gameState.players.length < 2) {
            // alert("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞!"); // –î–ª—è —Ç–µ—Å—Ç–æ–≤ –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å
        }
        gameState.gameActive = true;
        gameState.log.push("üèÅ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –í—Å–µ–º –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è.");
        showScreen('screen-game');
        broadcastState();
    }

    // --- –ò–ì–†–û–í–ê–Ø –ú–ï–•–ê–ù–ò–ö–ê (–¢–û–õ–¨–ö–û –ù–ê –•–û–°–¢–ï) ---

    function nextTurn() {
        gameState.turnIndex = (gameState.turnIndex + 1) % gameState.players.length;
        // –°–Ω–∏–º–∞–µ–º –∏–º–º—É–Ω–∏—Ç–µ—Ç —É —Ç–æ–≥–æ, —á–µ–π —Ö–æ–¥ –Ω–∞—Å—Ç–∞–ª (–æ–Ω –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª –Ω–∞ 1 –∫—Ä—É–≥)
        // –•–æ—Ç—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –∏–º–º—É–Ω–∏—Ç–µ—Ç –Ω–∞ "—Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥". 
        // –£–ø—Ä–æ—â–µ–Ω–∏–µ: –∏–º–º—É–Ω–∏—Ç–µ—Ç —Å–ª–µ—Ç–∞–µ—Ç –≤ –Ω–∞—á–∞–ª–µ —Ç–≤–æ–µ–≥–æ —Ö–æ–¥–∞.
        const currentPlayer = gameState.players[gameState.turnIndex];
        if (currentPlayer.immunity) {
             currentPlayer.immunity = false;
             addToLog(`üõ°Ô∏è –ò–º–º—É–Ω–∏—Ç–µ—Ç ${currentPlayer.name} –∏—Å—Ç–µ–∫.`, 'neutral');
        }
        broadcastState();
    }

    function processAction(action, payload, playerId) {
        const pIndex = gameState.players.findIndex(p => p.id === playerId);
        const player = gameState.players[pIndex];
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–µ—Ä–µ–¥–Ω–æ—Å—Ç–∏
        if (gameState.players[gameState.turnIndex].id !== playerId) return;

        let turnOver = true;

        switch(action) {
            case 'scheme':
                const profit = Math.floor(Math.random() * (800 - 400 + 1)) + 400;
                player.dirty += profit;
                player.risk += 20;
                addToLog(`üí∞ ${player.name} –ø—Ä–æ–≤–µ—Ä–Ω—É–ª —Å—Ö–µ–º—É: +${profit}$ (–†–∏—Å–∫ ${player.risk}%)`, 'good');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–±–ª–∞–≤—É
                checkBust(player);
                break;

            case 'clean':
                if (player.dirty > 0) {
                    player.clean += player.dirty;
                    const washed = player.dirty;
                    player.dirty = 0;
                    player.risk = 0;
                    addToLog(`üßº ${player.name} –æ—Ç–º—ã–ª ${washed}$. –†–∏—Å–∫ —Å–±—Ä–æ—à–µ–Ω.`, 'good');
                } else {
                    addToLog(`ü§î ${player.name} –ø—ã—Ç–∞–ª—Å—è –æ—Ç–º—ã—Ç—å –ø—É—Å—Ç–æ—Ç—É.`);
                }
                break;

            case 'lawyer':
                if (player.clean >= 500) {
                    player.clean -= 500;
                    player.immunity = true;
                    addToLog(`‚öñÔ∏è ${player.name} –Ω–∞–Ω—è–ª –ê–¥–≤–æ–∫–∞—Ç–∞. –ò–º–º—É–Ω–∏—Ç–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω!`, 'neutral');
                } else {
                    addToLog(`üö´ ${player.name} –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ –¥–µ–Ω–µ–≥ –Ω–∞ –∞–¥–≤–æ–∫–∞—Ç–∞!`, 'bad');
                }
                break;

            case 'steal':
                const targetId = payload.targetId;
                const target = gameState.players.find(p => p.id === targetId);
                
                if (target) {
                    if (target.immunity) {
                        addToLog(`üõ°Ô∏è ${player.name} –ø—ã—Ç–∞–ª—Å—è –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å ${target.name}, –Ω–æ —Å—Ä–∞–±–æ—Ç–∞–ª –ê–¥–≤–æ–∫–∞—Ç!`, 'bad');
                    } else if (target.dirty === 0) {
                        addToLog(`üö® –ü–û–î–°–¢–ê–í–ê –ù–ï –£–î–ê–õ–ê–°–¨! –£ ${target.name} —á–∏—Å—Ç–æ. ${player.name} —Å–ø–∞–ª–∏–ª—Å—è –ø–æ–ª–∏—Ü–∏–∏!`, 'bad');
                        player.dirty = 0;
                        player.risk = 0;
                    } else {
                        const stolen = Math.floor(target.dirty * 0.7);
                        target.dirty -= stolen;
                        player.dirty += stolen; // –í –ø—Ä–∞–≤–∏–ª–∞—Ö –Ω–µ —Å–∫–∞–∑–∞–Ω–æ –∫—É–¥–∞ –∏–¥—É—Ç –¥–µ–Ω—å–≥–∏, –ø—É—Å—Ç—å –∏–¥—É—Ç –≤–æ—Ä—É –≤ –∫–∞—Ä–º–∞–Ω
                        addToLog(`üî™ ${player.name} –ø–æ–¥—Å—Ç–∞–≤–∏–ª ${target.name} –∏ –∑–∞–±—Ä–∞–ª ${stolen}$!`, 'good');
                    }
                }
                break;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã
        if (player.clean >= 5000) {
            gameState.winner = player.name;
            addToLog(`üèÜ ${player.name} –°–¢–ê–õ –ö–û–†–û–õ–ï–ú –ü–†–ï–°–¢–£–ü–ù–û–ì–û –ú–ò–†–ê!`, 'good');
            gameState.gameActive = false;
        }

        if (gameState.gameActive) nextTurn();
        broadcastState();
    }

    function checkBust(player) {
        // –®–∞–Ω—Å –æ–±–ª–∞–≤—ã: –±—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–∞ 1-100. –ï—Å–ª–∏ —á–∏—Å–ª–æ < –†–∏—Å–∫–∞, —Ç–æ –ø—Ä–æ–≤–∞–ª.
        const roll = Math.floor(Math.random() * 100) + 1;
        if (roll <= player.risk) {
            addToLog(`üöì –û–ú–û–ù!!! ${player.name} –ø–æ–π–º–∞–Ω! –ö–æ–Ω—Ñ–∏—Å–∫–æ–≤–∞–Ω–æ: ${player.dirty}$`, 'bad');
            player.dirty = 0;
            player.risk = 0;
        } else {
            addToLog(`üòÖ ${player.name} –∏–∑–±–µ–∂–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ë—Ä–æ—Å–æ–∫: ${roll} > –†–∏—Å–∫: ${player.risk})`, 'neutral');
        }
    }

    function addToLog(msg, type) {
        gameState.log.push({text: msg, type: type});
        // –û–≥—Ä–∞–Ω–∏—á–∏–º –ª–æ–≥ 20 –∑–∞–ø–∏—Å—è–º–∏
        if(gameState.log.length > 20) gameState.log.shift();
    }

    // --- –õ–û–ì–ò–ö–ê –ö–õ–ò–ï–ù–¢–ê ---

    function handleClientData(data) {
        if (data.type === 'UPDATE') {
            gameState = data.state;
            if (gameState.gameActive) {
                showScreen('screen-game');
                updateGameUI();
            } else if (gameState.winner) {
                alert(`–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê! –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${gameState.winner}`);
            } else {
                updateLobbyUI();
            }
        }
    }

    function sendActionToHost(action, payload = {}) {
        if (isHost) {
            processAction(action, payload, myId);
        } else {
            hostConn.send({ type: 'ACTION', action: action, payload: payload });
        }
    }

    // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï UI ---

    function updateLobbyUI() {
        const list = document.getElementById('lobby-list');
        list.innerHTML = "";
        gameState.players.forEach(p => {
            const li = document.createElement('li');
            li.textContent = p.name + (p.id === myId ? " (–í—ã)" : "");
            list.appendChild(li);
        });
    }

    function updateGameUI() {
        const myPlayer = gameState.players.find(p => p.id === myId);
        if (!myPlayer) return;

        // –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        document.getElementById('game-me-name').innerText = myPlayer.name;
        document.getElementById('game-me-dirty').innerText = myPlayer.dirty + " $";
        document.getElementById('game-me-clean').innerText = myPlayer.clean + " $";
        document.getElementById('game-me-risk').innerText = myPlayer.risk + "%";
        
        // –ü—Ä–æ–≥—Ä–µ—Å—Å
        const pct = Math.min(100, (myPlayer.clean / 5000) * 100);
        document.getElementById('game-me-progress').style.width = pct + "%";

        // –ó–Ω–∞—á–æ–∫ –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞
        document.getElementById('immunity-badge').style.display = myPlayer.immunity ? 'block' : 'none';

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö–æ–¥–æ–º
        const currentPlayer = gameState.players[gameState.turnIndex];
        const isMyTurn = currentPlayer.id === myId;
        
        document.getElementById('action-panel').style.display = isMyTurn ? 'block' : 'none';
        document.getElementById('waiting-turn-msg').style.display = isMyTurn ? 'none' : 'block';
        document.getElementById('game-turn-indicator').style.display = isMyTurn ? 'inline' : 'none';

        if (!isMyTurn) {
            document.getElementById('waiting-turn-msg').innerText = `–•–æ–¥–∏—Ç: ${currentPlayer.name}`;
        }

        // –õ–æ–≥
        const logBox = document.getElementById('game-log');
        logBox.innerHTML = "";
        gameState.log.forEach(entry => {
            if (typeof entry === 'string') logToScreen(entry);
            else logToScreen(entry.text, entry.type);
        });

        // –°–æ–ø–µ—Ä–Ω–∏–∫–∏ (–≤—Å–µ –∫—Ä–æ–º–µ –º–µ–Ω—è)
        const oppList = document.getElementById('opponents-list');
        oppList.innerHTML = "";
        gameState.players.forEach(p => {
            if (p.id === myId) return;
            
            const div = document.createElement('div');
            div.className = 'card';
            div.style.padding = '10px';
            div.style.marginBottom = '5px';
            div.style.background = '#222';
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between">
                    <strong>${p.name}</strong>
                    <span style="color:var(--clean)">${p.clean}$</span>
                </div>
                <div style="font-size:0.9em; color:#888;">
                    –ö–∞—Ä–º–∞–Ω: ??? | –†–∏—Å–∫: ${p.risk}%
                    ${p.immunity ? 'üõ°Ô∏è' : ''}
                </div>
            `;
            oppList.appendChild(div);
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ü–µ–ª–µ–π –¥–ª—è –∫—Ä–∞–∂–∏
        const targetsDiv = document.getElementById('steal-targets');
        targetsDiv.innerHTML = "";
        gameState.players.forEach(p => {
            if (p.id === myId) return;
            const btn = document.createElement('button');
            btn.className = 'target-btn';
            btn.innerText = p.name;
            btn.onclick = () => {
                sendActionToHost('steal', {targetId: p.id});
                hideStealMenu();
            };
            targetsDiv.appendChild(btn);
        });
    }

    // --- –î–ï–ô–°–¢–í–ò–Ø ---
    function doAction(action) {
        sendActionToHost(action);
    }

    function showStealMenu() {
        document.getElementById('steal-menu').style.display = 'block';
    }
    
    function hideStealMenu() {
        document.getElementById('steal-menu').style.display = 'none';
    }

</script>
</body>
</html>